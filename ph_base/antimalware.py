import os
import sys
import datetime
import time
import requests
import urllib3
import traceback
from functions.ListAllPolicy import ListAllPolicy
from functions.GetPolicy import GetPolicy
from functions.AMconfigtenant1 import AMconfigtenant1
from functions.CreateandReplaceAMConfigTenant2 import AmconfigTenant2, AmReplaceConfig
from functions.AMCheckandRename import AmConfigCheck, RenameAmConfig
from functions.DirFileExtRenListTenant1 import (
    DirListTenant1,
    FileExtensionListTenant1,
    FileListTenant1,
    RenameLists,
)
from functions.DirFileExtListTenant2 import (
    DirListTenant2,
    FileExtensionListTenant2,
    FileListTenant2,
)


def am_config_transform(
    allofpolicy, antimalwareconfig, OLD_HOST, OLD_API_KEY, NEW_HOST, NEW_API_KEY
):
    amdirectorylist, amfileextentionlist, amfilelist, allamconfig = AMconfigtenant1(
        antimalwareconfig, OLD_HOST, OLD_API_KEY
    )

    # Directory Lists
    # NOTE that only lists that are attached to am configs will be transferred
    og_alldirectory = DirListTenant1(directorylist, OLD_HOST, OLD_API_KEY)
    og_allfileextention = FileExtensionListTenant1(
        fileextentionlist, OLD_HOST, OLD_API_KEY
    )
    og_allfilelist = FileListTenant1(filelist, OLD_HOST, OLD_API_KEY)

    alldirectory, allfilelist, allfileextention = RenameLists(
        og_alldirectory, og_allfilelist, og_allfileextention
    )

    alldirectorynew = DirListTenant2(alldirectory, NEW_HOST, NEW_API_KEY)
    allfileextentionnew = FileExtensionListTenant2(
        allfileextention, NEW_HOST, NEW_API_KEY
    )
    allfilelistnew = FileListTenant2(allfileextention, NEW_HOST, NEW_API_KEY)

    # Validate, rename, and modify allamconfignew

    allamconfig = AmConfigCheck(
        og_allamconfig,
        directorylist,
        alldirectorynew,
        fileextentionlist,
        allfileextentionnew,
        filelist,
        allfilelistnew,
    )

    allamconfig = RenameAmConfig(allamconfig)

    allamconfignew = AmconfigTenant2(allamconfig, NEW_HOST, NEW_API_KEY)

    aop_replace_am_configs = AmReplaceConfig(
        allofpolicy, antimalwareconfig, allamconfignew
    )
    final = aop_replace_am_configs
    return final, allamconfig, amdirectorylist, amfileextentionlist, amfilelist
